#include <iostream>
#include <stdlib.h>

#include "./lib/rtaudio/RtAudio.h"
#include <windows.h>

#include <chrono>
#include <ctime>
#include <time.h>

#include <inttypes.h>
#include <math.h>


//read keys
#include <conio.h>  //provides non standard getch() function



#define FD 44100

using namespace std;


int generateNext();
void outputRt(int level, double *buf);
int saw( void *outputBuffer, void *inputBuffer, unsigned int nBufferFrames,
         double streamTime, RtAudioStreamStatus status, void *userData );

int generator( void *outputBuffer, void *inputBuffer, unsigned int nBufferFrames,
         double streamTime, RtAudioStreamStatus status, void *userData );

int diff(timespec start, timespec end);

void outputVisual(int level);

int generateNoise();
double generateNoiseNormalized();

void processKey(char key);


int NUM_FRAMES = 512;
int MIN_LEVEL = 0;
int MAX_LEVEL = 1024;

int IS_OUTPUT_SOUND = 1; //can be console log of vaweform
int OUTPUT_TO_SPEAKER = 1;
int OUTPUT_TO_SPECTRUM_ANALYZER = 0; //for this you need: 
//a vitrual cable https://vb-audio.com/Cable/index.htm and a 
//spectrum analyzer http://www.sillanumsoft.org/

///////////////////////////////////////
//control keys
int KEY_Q = 0; //enable/disable
int KEY_V = false; //verbose
int fbw = 0; //fake band width



///////////////////////////////////////






int main(){
	//setup and stuff
	double fd = (double) FD;
	double T_ns = (1.0/fd)*1000000000.0;
	int runFramer = 1;
	int idle = 1;
	unsigned long duration = 0;
	timespec time1, time2;

	int temp = 0;

	//init generators
	time_t t;
	srand((unsigned) time(&t));

	cout << " ===== Starting emulation ===== \n";

	if(IS_OUTPUT_SOUND){
		//init RtAudio
		RtAudio aud1;
		RtAudio aud2;

		//list devices
		unsigned int devices = aud1.getDeviceCount();
		if ( devices < 1 ) {
			std::cout << "\nNo audio devices found!\n";
			exit( 0 );
		}
		RtAudio::DeviceInfo info;
		for ( unsigned int i=0; i<devices; i++ ) {
			info = aud1.getDeviceInfo( i );
			if ( info.probed == true ) {
				// Print, for example, the maximum number of output channels for each device
				std::cout << "device = " << i;
				std::cout << ": maximum output channels = " << info.outputChannels << "\n";
			}
		}

		if(OUTPUT_TO_SPEAKER){
			RtAudio::StreamParameters parameters;
			parameters.deviceId = aud1.getDefaultOutputDevice();
			parameters.nChannels = 1;
			parameters.firstChannel = 0;
			unsigned int sampleRate = (int)fd;
			unsigned int bufferFrames = NUM_FRAMES; // 256 sample frames
			double data[2];

			aud1.openStream( &parameters, NULL, RTAUDIO_FLOAT64, sampleRate, &bufferFrames, &generator, (void *)&data );
			aud1.startStream();
		}
		if(OUTPUT_TO_SPECTRUM_ANALYZER){
			
			RtAudio::StreamParameters parameters2;
			parameters2.deviceId = 2;
			parameters2.nChannels = 1;
			parameters2.firstChannel = 0;
			unsigned int sampleRate = (int)fd;
			unsigned int bufferFrames = NUM_FRAMES; // 256 sample frames
			double data[2];

			aud2.openStream( &parameters2, NULL, RTAUDIO_FLOAT64, sampleRate, &bufferFrames, &generator, (void *)&data );
			aud2.startStream();
		}
		


		cout << "\nPlaying ... press <enter> to quit.\n";


		// Keypress detection for live twiggle

		int keepReading = 1;

		while(keepReading){
			char c = getch();

			if(c == 13 || c == '\n'){
				if(OUTPUT_TO_SPEAKER){
					aud1.stopStream();
					if(aud1.isStreamOpen()) aud1.closeStream();
				}

				if(OUTPUT_TO_SPECTRUM_ANALYZER){
					aud2.stopStream();
					if(aud2.isStreamOpen()) aud2.closeStream();
				}	

				keepReading = 0;	
			}else{
				processKey(c);
			}
		}


	}else{
		//UNDEVELOPED. use int generator() for output

		int counter=0;
		int level=0;

		while(runFramer){
			clock_gettime(CLOCK_MONOTONIC, &time1);
			counter++;
			
			//frame stated generation
			outputVisual(level);

			level = generateNoise();
			
			cout << "\n";

			//frame generated
			idle = 1;
			while(idle){
				//http://www.catb.org/esr/time-programming/
				clock_gettime(CLOCK_MONOTONIC, &time2);
				if(diff(time1,time2) >= T_ns){
					idle = 0;
					//cout << diff(time1,time2) << "\n";
				}
			}

			if(counter >= NUM_FRAMES)
				runFramer = 0;
		}

		cout << "[FG] generated " << counter << " frames of audio\n";
	}
	
	cout << " =====   Emulation done   =====\n\n\n\n"; 
	
	return 0;
}







//this will be called when audio stream needs new chunk.
//chunk size is 256 bytes.
//the function will generate 256 samples and return to

/////////////////////////////////////////////////////////////////////
// optimization: 
/////////////////////////////////////////////////////////////////////
// save cycles on array.push() by overflowing itterator:
// 			https://www.avrfreaks.net/forum/circular-buffer
// doubles to uint32_t (much much more precision)
// 			https://www.avrfreaks.net/forum/floating-point-and-avr?name=PNphpBB2&file=viewtopic&t=113173
/////////////////////////////////////////////////////////////////////




//synth select
// 1: NoiseVoice noise processor
int SYNTH = 1;





/////////////////////////////////////////////////////////////////////
// Common components
/////////////////////////////////////////////////////////////////////
// filter explorer http://jaggedplanet.com/iir/iir-explorer.asp



/////////////////////////////////////////////////////////////////////
// SYNTH 1 variables
/////////////////////////////////////////////////////////////////////

typedef double REAL;

//PROGMEM:
REAL biquadA1[]={-1.9998354813591794,-1.999847678373505,-1.9998199989905208,-1.999771777035376,-1.9997074153908536,-1.9996207875254726,-1.9995197700514233,-1.999394743471039,-1.9992570750320044,-1.9990936548609062,-1.9989193408104535,-1.9987175332821079,-1.9985065802155861,-1.998266392937288,-1.9980188087919721,-1.997740250792059,-1.9974420652151466,-1.9971391266090825,-1.9968025866798664,-1.9964630429580381,-1.9960881613103807,-1.9957120252187324,-1.9952988159245943,-1.9948861015818145,-1.9944345801511907,-1.993985303048495,-1.9934954864290622,-1.99300966342977,-1.9924815700063758,-1.9919592193453632,-1.9913928689394018,-1.9908069533232418,-1.9902294240911753,-1.9896052841804668,-1.9889912791300202,-1.9883289383509708,-1.9876784805279366,-1.9869779637405376,-1.9862910775588865,-1.985552411055984,-1.98482912229695,-1.9840523338032692,-1.9832926696143887,-1.9824777882854898,-1.9816817771795858,-1.9808288336007775,-1.9799564286024645,-1.9791055316400827,-1.9781951133370261,-1.9773079470848525,-1.9763595496481783,-1.9754361474046078,-1.9744498064309257,-1.9734902028544117,-1.97246595536448,-1.9714701864722328,-1.9704080709095686,-1.9693761740762055,-1.9682762303056436,-1.9672082442617853,-1.96607051356798,-1.9649134664535355,-1.963791003484675,-1.9625962345458448,-1.9614377856135434,-1.9602053396940926,-1.9590109482788993,-1.9577408716367393,-1.9565105825682494,-1.9552029228736996,-1.9539367823288691,-1.9525915886628697,-1.9512896441642829,-1.9499069670165503,-1.9485692674306359,-1.947149158697772,-1.9457099194444543,-1.9443182672165087,-1.9428416774927848,-1.9414143988257953,-1.939900514053125,-1.9384376625177393,-1.9368865395173938,-1.9353881700194295,-1.9337998670103569,-1.932266035788744,-1.9306406123853845,-1.9290713770100516,-1.9274088942201024,-1.9258043135898169,-1.9241048338119384,-1.9223864499214984,-1.9207285551735735,-1.9189732712540464,-1.9172801850282846,-1.9154880669614749,-1.9137598528051893,-1.9119309678554133,-1.910167690634388,-1.9083021074459483,-1.906503833342004,-1.904601621936614,-1.9027684184451241,-1.90082965021928,-1.8989615861466365,-1.896986333868935,-1.894992443914871,-1.893071817138378,-1.8910415557301103,-1.8890862469528003,-1.8870196902929786,-1.8850297729042722,-1.882926998557831,-1.8809025472461283,-1.8787636341373757,-1.8767047248872546,-1.8745297532969083,-1.8724364633862696,-1.8702255149484481,-1.8680979229456152,-1.8658510806447688,-1.8635859065679055,-1.8614066145733412,-1.8591056746315007,-1.8568922835501667,-1.8545556641054886,-1.8523082570135159,-1.849936045767314,-1.8476547070175722,-1.8452469930070414,-1.84293180822597,-1.8404886818208468,-1.8381397379052438,-1.835661290804411,-1.8332786759181683,-1.8307650011462167,-1.8282333393150139,-1.8257999966207477,-1.8232332502458388,-1.8207664635815937,-1.8181647290017426,-1.815664590954452,-1.8130279658216488,-1.8104945702300372,-1.807823153505835,-1.805256595456898,-1.802550487408695,-1.799950863234127,-1.7972101654314079,-1.7945775727039888,-1.7918023880145084,-1.7890095990690469,-1.7863273581303636,-1.7835002402518572,-1.7807852812755578,-1.7779239405754017,-1.7751763654631754,-1.772280909337265,-1.769500821214996,-1.7665713583396945,-1.7637588615535917,-1.760795501881653,-1.7579507019943321,-1.754953556750772,-1.7520765605372959,-1.7490457422152186,-1.745997739716375,-1.7430722800154625,-1.7399907768836624,-1.737033394355954,-1.733918506250542,-1.7309293118967113,-1.7277811557300824,-1.7247602617448092,-1.721578955678024,-1.7185264754457847,-1.7153121388841321,-1.7122281869749412,-1.708980940563457,-1.7058656327285695,-1.7025855983475104,-1.699288836255348,-1.6961263522753414,-1.692796988785866,-1.68960344478453,-1.6862416048601327,-1.6830171207020874,-1.679622930524109,-1.676367627235266,-1.6729412141992637,-1.66965521396228,-1.6661967066732455,-1.6628801328229397,-1.6593896610904717,-1.6560426381091955,-1.6525203329426266,-1.6489817919505299,-1.6455889800590717,-1.6420188059367833,-1.63859586259717,-1.6349941893455264,-1.631541243032519,-1.6279082058346261,-1.6244253861490998,-1.6207611213652606,-1.6172485590293413,-1.6135532041919356,-1.610011031044093,-1.6062847248524161,-1.6027130738425135,-1.5989559561575735,-1.595183128911054,-1.5915671731811425,-1.5877637480527835,-1.5841186532493996,-1.5802847729947453,-1.5766106759307545,-1.572746484448433,-1.5690435230252548,-1.5651491653515786,-1.5614174785540105,-1.5574931008575321,-1.5537328287485332,-1.54977857832456,-1.5459898620399928,-1.5420058873050568,-1.5380067625365323,-1.5341753195346808,-1.5301466969218243,-1.5262871689214017,-1.5222291996721882,-1.5183417315344707,-1.5142545679583546,-1.5103393055933072,-1.5062231010955054,-1.5022801914563053,-1.4981351005320398,-1.4941646916095614,-1.4899908698382613,-1.48599311065552,-1.4817907146949802,-1.4775737603081194,-1.4735349428820448,-1.469289653148252,-1.465223864266785,-1.4609503985262926,-1.4568577907923859,-1.4525563094429677,-1.448437036466176,-1.4441077009571284,-1.4399619173478442,-1.4356048901739242,-1.4314327515375747,-1.4270481962329031,-1.42284985916411,-1.418437940296031,-1.4140120854354803,-1.4097744455356414,-1.4053214778239336,-1.401058037122299,-1.3965781236945312,-1.3922890422126009,-1.3877823512152347,-1.383467789936896,-1.3789344905214465,-1.3745946113869283,-1.3700348737036145,-1.3656698396034133,-1.3610838347947747,-1.356693809563538,-1.3520817097580078,-1.3476668581683857,-1.343028836473832,-1.3383776196727293,-1.33392555472752,-1.329248679556913,-1.3247722061963474,-1.320069848195345,-1.3155691344367668,-1.3108414701009354,-1.306316684871513,-1.3015638916462526,-1.2970152047766401,-1.2922374610505227,-1.2876650432684837,-1.2828625283665602,-1.278266551290561,-1.273439445467628,-1.2685998282460487,-1.2639685660342315,-1.259104632119742,-1.2544502455408433,-1.2495621774935062,-1.244884841242561,-1.2399728225282756,-1.2352727121616986,-1.2303369271453142,-1.2256142190743105,-1.220654853012707,-1.2159097244966508,-1.210926963531786,-1.2061595926715676,-1.2011536238234886,-1.1961358537767925,-1.1913352007146563,-1.1862945071407633,-1.1814720627242619,-1.1764086348176284,-1.171564580049583,-1.166478607857964,-1.1616131245523045,-1.156504798969617,-1.1516180697445602,-1.146487582503722,-1.1415797907749163,-1.1364273344406477,-1.1314986644142893,-1.1263244323758843,-1.1211391343272123,-1.116179255505876,-1.1109724756348958,-1.1059921846137801,-1.1007641183487353,-1.0957636020551835,-1.0905144456232687,-1.0854938917437478,-1.0802238421637422,-1.075183439136796,-1.0698926942116722,-1.0648326312208523,-1.059521389530349,-1.0544418564971136,-1.0491103173902818,-1.0437684708931374,-1.0386598685545896,-1.0332980274264794,-1.0281704352643313,-1.0227888007534773,-1.0176424112237867,-1.0122411853213256,-1.007076191585679,-1.001655577018077,-0.9964721729363418,-0.9910323731577894,-0.9858307532808351,-0.9803719724656084,-0.975152332028007,-0.9696747750628059,-0.9641876911525181,-0.9589411824517574,-0.9534356334392634,-0.9481715975008781,-0.9426477900282465,-0.9373664244294957,-0.9318245658241001,-0.9265260687926844,-0.9209663670594167,-0.9156509374660373,-0.9100736012795059,-0.9047414386304006,-0.8991466773270931,-0.8937979817565501,-0.888186005326978,-0.8825653025702737,-0.8771919966706405,-0.8715543974392191,-0.8661650640007973,-0.8605107798930259,-0.8551056211959178,-0.849434864436402,-0.8440140833546862,-0.8383270667863072,-0.8328908667804245,-0.8271878038563506,-0.8217363889654646,-0.8160174937411379,-0.8105510685754801,-0.8048165557005835,-0.7990741355939757,-0.7935854101441718,-0.7878276979675956,-0.7823244786151787,-0.7765516904752504,-0.7710341837748509,-0.7652465363440373,-0.7597149493865377,-0.7539126598950271,-0.748367200299791,-0.7425504865273375,-0.7369913624344147,-0.7311604427021657,-0.725587862764483,-0.7197429559267832,-0.7138909776958758,-0.7082984547384887,-0.7024328212223904,-0.6968273686885236,-0.6909483000445077,-0.6853301283259522,-0.6794378452155554,-0.6738071651814961,-0.6679018887622421,-0.6622589117513442,-0.6563408636684382,-0.6506858014809143,-0.6447552038589263,-0.6390882687485865,-0.633145344183113,-0.6271961990361817,-0.6215117203987113,-0.6155505856656035,-0.6098547691553791,-0.6038818685778536,-0.5981749279783356,-0.5921904857397641,-0.5864726352519367,-0.5804768759688893,-0.5747483302032228,-0.5687414789170351,-0.5630024528854299,-0.5569847350537601,-0.5512354441614762,-0.545207085649841,-0.539173370540201,-0.5334089727607111,-0.5273649591511279,-0.5215908392098678,-0.5155367539528287,-0.5097531285722524,-0.5036891988982678,-0.4978962851576022,-0.49182273866667614,-0.4860207539937713,-0.47993781864686075,-0.47412698081003113,-0.4680348849204878,-0.4622154120203348,-0.45611438424533896,-0.45000887519805993,-0.4441767640385433,-0.4380626693840044,-0.43222247235978595,-0.4261000215808542,-0.42025195789448794,-0.4141213807876652,-0.40826566993696767,-0.40212719660376356,-0.3962640583735749,-0.3901179192118734,-0.3842475736658097,-0.37809399936121757,-0.37221666683340937,-0.36605588835060116,-0.3598915134100558,-0.3540040380114709,-0.3478328085358485,-0.3419389006909583,-0.3357610483075916,-0.3298609292349007,-0.3236766858197027,-0.31777057697084377,-0.3115801746396058,-0.30566829769102877,-0.2994719687907057,-0.2935545456353567,-0.2873525227353488,-0.281429775474342,-0.2752222913577642,-0.26901210321327573,-0.263081729946992,-0.2568664328536716,-0.25093129417979343,-0.2447111214189817,-0.23877144010354692,-0.23254662513958604,-0.2266026241191346,-0.22037340059060326,-0.2144253029638071,-0.20819190467475363,-0.20223993369404458,-0.19600259460520994,-0.19004697366839995,-0.18380592788843653,-0.1775630762360027,-0.17160236230701925,-0.16535615810988702,-0.1593923559024806,-0.15314303360203985,-0.14717636695808897,-0.14092416111276335,-0.13495485398165913,-0.1286999992581023,-0.1227282756883408,-0.11647100685262589,-0.11049709098340284,-0.1042376428922142,-0.09826175894500819,-0.0920003665368253,-0.0857380702354372,-0.07975963709326178,-0.07349575175011817,-0.0675159139979325,-0.06125067471805883,-0.05526965679961126,-0.04900329873884821,-0.043021325142181946,-0.036754083498363406,-0.030771378747391127,-0.024503488751515073,-0.01852027739759184,-0.012251974304991768,-0.006268480918488115,-1.1101439402702114e-16,0.006268480918487304,0.012251974304991186,0.018520277397591524,0.024503488751515333,0.030771378747391286,0.03675408349836393,0.04302132514218172,0.04900329873884842,0.055269656799611454,0.06125067471806002,0.06751591399793358,0.07349575175011924,0.07975963709326207,0.08573807023543849,0.092000366536826,0.09826175894500981,0.10423764289221639,0.1104970909834051,0.11647100685262812,0.1227282756883428,0.12869999925810457,0.13495485398166207,0.14092416111276726,0.1471763669580929,0.15314303360204412,0.15939235590248446,0.1653561581098909,0.17160236230702425,0.17756307623600773,0.1838059278884429,0.19004697366840614,0.1960025946052167,0.20223993369405144,0.20819190467476123,0.21442530296381518,0.220373400590612,0.2266026241191435,0.23254662513959573,0.23877144010355744,0.24471112141899243,0.25093129417980453,0.256866432853683,0.26308172994700446,0.26901210321328894,0.27522229135777765,0.2814297754743564,0.28735252273536366,0.2935545456353723,0.2994719687907219,0.3056682976910456,0.31158017463962356,0.31777057697086264,0.3236766858197223,0.3298609292349204,0.3357610483076124,0.3419389006909796,0.347832808535871,0.3540040380114938,0.35989151341007974,0.3660558883506258,0.3722166668334346,0.37809399936124405,0.38424757366583734,0.39011791921190203,0.3962640583736043,0.40212719660379426,0.4082656699369986,0.41412138078769695,0.4202519578945214,0.4261000215808885,0.43222247235982164,0.4380626693840407,0.4441767640385804,0.4500088751980983,0.45611438424537765,0.4622154120203754,0.4680348849205293,0.4741269808100733,0.4799378186469043,0.4860207539938169,0.49182273866672205,0.4978962851576497,0.503689198898317,0.5097531285723026,0.5155367539528801,0.5215908392099202,0.5273649591511816,0.5334089727607663,0.5391733705402566,0.5452070856498986,0.5512354441615357,0.5569847350538214,0.5630024528854916,0.5687414789170984,0.574748330203287,0.5804768759689556,0.5864726352520045,0.5921904857398332,0.5981749279784067,0.603881868577926,0.6098547691554526,0.6155505856656789,0.6215117203987883,0.6271961990362604,0.6331453441831939,0.6390882687486683,0.6447552038590095,0.6506858014809995,0.6563408636685247,0.6622589117514329,0.6679018887623323,0.6738071651815885,0.6794378452156492,0.6853301283260481,0.6909483000446051,0.6968273686886237,0.7024328212224923,0.7082984547385919,0.7138909776959812,0.7197429559268904,0.7255878627645923,0.7311604427022766,0.736991362434528,0.7425504865274527,0.7483672002999087,0.7539126598951464,0.75971494938666,0.7652465363441613,0.771034183774977,0.7765516904753784,0.7823244786153094,0.7878276979677282,0.793585410144307,0.799074135594112,0.8048165557007229,0.8105510685756218,0.8160174937412823,0.8217363889656111,0.8271878038564998,0.8328908667805759,0.838327066786462,0.8440140833548424,0.8494348644365604,0.8551056211960795,0.8605107798931891,0.8661650640009643,0.871554397439388,0.8771919966708126,0.8825653025704482,0.8881860053271557,0.8937979817567301,0.8991466773272763,0.9047414386305868,0.9100736012796943,0.9156509374662283,0.9209663670596112,0.9265260687928812,0.9318245658243002,0.9373664244296989,0.9426477900284533,0.9481715975010879,0.9534356334394753,0.9589411824519731,0.9641876911527366,0.969674775063028,0.9751523320282321,0.9803719724658365,0.9858307532810672,0.9910323731580248,0.9964721729365803,1.0016555770183186,1.0070761915859243,1.012241185321574,1.0176424112240396,1.0227888007537336,1.02817043526459,1.0332980274267425,1.038659868554856,1.0437684708934074,1.0491103173905563,1.0544418564973914,1.059521389530631,1.0648326312211387,1.0698926942119613,1.0751834391370898,1.0802238421640402,1.085493891744049,1.0905144456235747,1.0957636020554937,1.1007641183490493,1.1059921846140988,1.1109724756352184,1.1161792555062027,1.1211391343275439,1.12632443237622,1.1314986644146297,1.136427334440992,1.141579790775266,1.146487582504076,1.151618069744918,1.15650479896998,1.1616131245526726,1.166478607858337,1.1715645800499603,1.176408634818011,1.1814720627246489,1.1862945071411553,1.1913352007150535,1.1961358537771951,1.201153623823897,1.2061595926719804,1.210926963532204,1.2159097244970747,1.220654853013137,1.2256142190747452,1.2303369271457543,1.2352727121621445,1.2399728225287268,1.2448848412430191,1.2495621774939687,1.2544502455413118,1.2591046321202168,1.263968566034712,1.2685998282465352,1.2734394454681204,1.2782665512910603,1.2828625283670656,1.2876650432689958,1.2922374610510403,1.297015204777165,1.3015638916467833,1.3063166848720513,1.3108414701014794,1.3155691344373182,1.3200698481959032,1.3247722061969125,1.3292486795574845,1.3339255547280993,1.338377619673316,1.3430288364744254,1.3476668581689875,1.3520817097586169,1.3566938095641545,1.3610838347953989,1.3656698396040448,1.370034873704254,1.374594611387575,1.3789344905221006,1.3834677899375594,1.3877823512159062,1.3922890422132814,1.396578123695219,1.4010580371229953,1.4053214778246388,1.4097744455363557,1.4142135623734562,1.4184379402967628,1.4228498591648504,1.427048196233653,1.4314327515383345,1.435604890174693,1.4399619173486222,1.4441077009579164,1.4484370364669736,1.4525563094437748,1.4568577907932032,1.46095039852712,1.4652238642676234,1.4692896531490998,1.473534942882903,1.4775737603089882,1.4817907146958609,1.485993110656411,1.489990869839163,1.494164691610475,1.4981351005329642,1.5022801914572417,1.5062231010964524,1.5103393055942667,1.5142545679593262,1.5183417315354544,1.5222291996731836,1.5262871689224102,1.530146696922845,1.5341753195357146,1.5380067625375788,1.5420058873061169,1.5459898620410668,1.5497785783256461,1.553732828749634,1.5574931008586468,1.5614174785551393,1.565149165352721,1.5690435230264124,1.5727464844496049,1.5766106759319418,1.5802847729959473,1.584118653250617,1.5877637480540159,1.591567173182391,1.5951831289123184,1.5989559561588544,1.6027130738438111,1.6062847248537306,1.610011031045424,1.6135532041932834,1.6172485590307077,1.6207611213666444,1.6244253861505018,1.627908205836046,1.6315412430339569,1.6349941893469835,1.6385958625986468,1.642018805938279,1.6455889800605872,1.6489817919520653,1.6525203329441827,1.6560426381107727,1.6593896610920695,1.6628801328245588,1.6661967066748862,1.6696552139639427,1.6729412142009483,1.6763676272369739,1.6796229305258394,1.6830171207038425,1.6862416048619104,1.689603444786333,1.692796988787693,1.696126352277194,1.6992888362572247,1.702585598349414,1.7058656327305008,1.7089809405654142,1.7122281869769262,1.7153121388861439,1.718526475447826,1.7215789556800931,1.724760261746908,1.7277811557322096,1.7309293118988702,1.7339185062527303,1.7370333943581748,1.7399907768859144,1.7430722800177476,1.745997739718693,1.7490457422175703,1.7520765605396829,1.7549535567531938,1.7579507019967897,1.7607955018841457,1.7637588615561224,1.7665713583422624,1.769500821217603,1.77228090933991,1.7751763654658608,1.7779239405781275,1.7807852812783254,1.7835002402546658,1.7863273581332173,1.789009599071944,1.7918023880174498,1.7945775727069782,1.797210165434442,1.7999508632372103,1.8025504874118263,1.8052565954600792,1.8078231535090659,1.8104945702333217,1.8130279658249846,1.815664590957843,1.818164729005188,1.8207664635850962,1.8232332502493984,1.8257999966243672,1.8282333393186911,1.8307650011499572,1.833278675921974,1.8356612908082792,1.8381397379091788,1.8404886818248485,1.8429318082300423,1.8452469930111828,1.8476547070217864,1.8499360457716003,1.85230825701788,1.8545556641099277,1.8568922835546877,1.8591056746361008,1.861406614578027,1.8635859065726743,1.8658510806496271,1.8680979229505656,1.8702255149534883,1.8724364633914063,1.8745297533021406,1.8767047248925879,1.878763634142809,1.8809025472516694,1.8829269985634756,1.8850297729100305,1.887019690298848,1.889086246958789,1.8910415557362161,1.8930718171446097,1.894992443921227,1.896986333875425,1.8989615861532632,1.9008296502260418,1.9027684184520322,1.9046016219436654,1.9065038333492095,1.9083021074533062,1.9101676906419096,1.9119309678630962,1.913759852813047,1.9154880669695042,1.9172801850365004,1.9189732712624452,1.9207285551821704,1.9223864499302905,1.9241048338209426,1.92580431359904,1.9274088942295418,1.929071377019725,1.930640612395289,1.9322660357988999,1.9337998670207606,1.9353881700301034,1.936886539528334,1.9384376625289694,1.9399005140646424,1.9414143988376242,1.9428416775049233,1.9443182672289843,1.9457099194572647,1.9471491587109468,1.9485692674441903,1.9499069670304827,1.9512896441786272,1.9525915886776237,1.953936782344071,1.955202922889348,1.9565105825843856,1.9577408716533629,1.959010948296057,1.9602053397117833,1.9614377856318184,1.9625962345647054,1.9637910035041777,1.964913466473682,1.9660705135888348,1.9672082442833856,1.9682762303279921,1.96937617409938,1.9704080709335747,1.971470186497157,1.9724659553903294,1.9734902028812868,1.9744498064588363,1.9754361474336677,1.9763595496784012,1.9773079471163686,1.9781951133698559,1.9791055316743753,1.9799564286382476,1.980828833638226,1.9816817772188162,1.9824777883265423,1.9832926696574862,1.9840523338484648,1.98482912234451,1.9855524111059764,1.9862910776116298,1.9869779637961216,1.9876784805867502,1.9883289384131317,1.9889912791960043,1.9896052842504348,1.9902294241657146,1.990806953402572,1.9913928690242593,1.991959219436346,1.9924815701038394,1.9930096635347918,1.9934954865421453,1.9939853031710546,1.9944345802839503,1.9948861017266808,1.995298816082625,1.995712025392569,1.9960881615016182,1.9964630431704555,1.996802586915952,1.9971391268744638,1.9974420655138783,1.9977402511329387,1.998018809184576,1.998266393391065,1.9985065807501377,1.9987175339156762,1.9989193415804196,1.9990936558067,1.9992570762353499,1.9993947450325105,1.9995197721910865,1.9996207905783407,1.999707420205744,1.9997717854644672,1.999820018252504,1.9998477519744515};

REAL biquadA0;
REAL level = 0;

REAL xyv[]={0,0,0,0,0,0};
REAL buffer[]={0,0,0,0,0,0};

//filter  a(1) = -1.287 and a(2)= .8282   | Digital_Resonators.pdf


//Filter variables
int cutoff = 30;
int bw = 6;
REAL gain; 

/* the right way stuff
REAL a;
REAL th;
REAL poleR;
REAL poleI;

REAL w0;
REAL w1;
REAL w2;
REAL wd;

REAL pwdI;
REAL pwdR;

REAL dR;
REAL dI;

REAL warp(REAL cutoff){
	return 2 * tan(3.14 * cutoff / FD);
}
*/


/////////////////////////////////////////////////////////////////////

int generator( void *outputBuffer, void *inputBuffer, unsigned int nBufferFrames, double streamTime, RtAudioStreamStatus status, void *userData ){
	double *RTbuffer = (double *) outputBuffer;
	double *lastValues = (double *) userData;


	if ( status ) std::cout << "Stream underflow detected!" << std::endl;


	for (int frame=0; frame < nBufferFrames; frame++ ) {

		//*RTbuffer++ = ((level - MAX_LEVEL/2) / (double) MAX_LEVEL); //output(level)
		*RTbuffer++ = level;

		///////////////////////////////////////////////////////////////////// 
		////////        SYNTH: NoiseVoice noise manipulator          ////////
		/////////////////////////////////////////////////////////////////////
		
		//rough approximation of needed parameters:
		biquadA0 = (0.9998575342914282 + 0.00006707473460730674 - bw * 0.00006707473460730674);
		gain = ( 13800.0 / (bw + 20) );

		//cout << "gain: " << gain << "\tbw: " << bw << endl;
		
		////////////////////////
		// Source, noise
		level = generateNoise();

		//level = generateNoiseNormalized();

		////////////////////////
		// Filter, order 1	
		//REAL biquada[]={0.998576255387875,-0.242010717627489};
		//REAL biquadb[]={-1,0};

//----------------------------------------------------------
//-------------------- this works ------------------------
/*		
		int b, xp=0, yp=3, bqp=0; //x-pointer, y-pointer, biquad-pointer
		
		REAL out = level / gain;

		//buffer
		for (int i=5; i>0; i--) 
			xyv[i] = xyv[i-1];

		int len=2;
		xyv[xp]=out;

		//out += xyv[xp+len-0] * biquadb[bqp+0] - xyv[yp+len-0] * biquada[bqp+0];
		out += -xyv[xp+len-0] - xyv[yp+len-0] * biquadA0;
		out += 				0 - xyv[yp+len-1] * biquadA1[cutoff];

		xyv[yp]=out;
		level = out;
*/
//----------------------------------------------------------
//----------------- simplify -------------------------------
		//1x buffer structure
		//[ in xx xx | out xx xx ]
		//  g     f        f  f
		//  a     l    ^   l  l
		//  i     t    |   t  t
		//  n     r    |   r  r
		//  e     |    ^   |  |
		//  d     |____|___|__|


		REAL out = level / gain;

		if(KEY_V)
			cout << "After gain: \t" << out << endl;

		//rotate buffer
		for (int i=5; i>0; i--)
			buffer[i] = buffer[i-1];

		if(KEY_V)
			cout << "buffer state: \t[ " 
			<< buffer[0] << "  " 
			<< buffer[1] << "  "
			<< buffer[2] << " | "
			<< buffer[3] << "  "
			<< buffer[4] << "  "
			<< buffer[5] << " ]"
			<< endl;

		//write input to buffer
		buffer[0]=out;

		//filter
		out += -buffer[2] -buffer[4]*biquadA1[cutoff] -buffer[5]*biquadA0;

		if(KEY_V)
			cout << "buffer[4]*biquadA1[cutoff]: \t" << buffer[4]*biquadA1[cutoff]
			<< "  buffer[5]*biquadA0: \t" << buffer[5]*biquadA0 << endl;


		buffer[3] = out;

		level = out;

		if(KEY_V)
			cout << "Output: \t" << level << endl;


//----------------------------------------------------------


		////////////////////////

//prepare output for soundcard
		//0 .. 1023 -> -1 .. 1
		// 
		level = level/512.0 - 1;

	
		/////////////////////////////////////////////////////

		if(KEY_V){
			cout << "----------------------------------------------" << endl;
			KEY_V=false;
		}
	
	}
	return 0;
}



/////////////////////////////////////////////////////////////////////////////
/////                                                                   /////
/////                            KEY BINDINGS                           /////
/////                                                                   /////
/////////////////////////////////////////////////////////////////////////////

void processKey(char key){

//'pitch', 0...1024
	if(key=='q'){ 
		cutoff += 16;
		if(cutoff >= 1024) cutoff = 1024;
		cout << "q,a - Cutoff: " << cutoff << endl;
	}else if(key=='a'){
		cutoff -= 1;
		if(cutoff <= 1) cutoff = 1;
		cout << "q,a - Cutoff: " << cutoff << endl;
	}



//bandwidth, 0...1024
	else if(key=='w'){ 
		bw += 1;
		if(bw >= 1024) bw = 1024;
		cout << "w,s - Band Width: " << bw << endl;
	}else if(key=='s'){
		bw -= 1;
		if(bw <= 1) bw = 1;
		cout << "w,s - Band Width: " << bw << endl;
	}
	//bw=2 is octave down
	//numbers corrected after 25 seconds


// TOGGLERS
	else if(key=='v'){ 
		KEY_V = true;
	}

}



int generateNoise(){
	return rand() % MAX_LEVEL;
}
double generateNoiseNormalized(){
	return ((rand() % 1024) - 512 )/ 1024.0;
}




//1596657151
//1596657028263054000
int diff(timespec start, timespec end){
    timespec temp;
    if ((end.tv_nsec-start.tv_nsec)<0) {
        temp.tv_sec = end.tv_sec-start.tv_sec-1;
        temp.tv_nsec = 1000000000+end.tv_nsec-start.tv_nsec;
    } else {
        temp.tv_sec = end.tv_sec-start.tv_sec;
        temp.tv_nsec = end.tv_nsec-start.tv_nsec;
    }
    return temp.tv_sec*1000000000 + temp.tv_nsec ;
}

void outputVisual(int level){
	//1024 is max, 1024/8 = 128, will allow overamp till 200

	int HAT = 100;
	int RESOLUTION_DIVIDER = 16;

	int maxVolume = 1024/RESOLUTION_DIVIDER;
	int displayLevel = level/RESOLUTION_DIVIDER;

	string bar = "[";

	if(displayLevel > 200)
		cout << "AMP TOO HIGH! " << level;
	else{
		for(int i=0; i<(maxVolume+HAT); i++){
			if(i<displayLevel || (i>displayLevel && i<maxVolume))
				bar+=' ';
			
			if(i==displayLevel)
				bar+='*';

			if(i==maxVolume)
				bar+="|";	
		}

		bar+=']';
	}
}

int saw( void *outputBuffer, void *inputBuffer, unsigned int nBufferFrames,
         double streamTime, RtAudioStreamStatus status, void *userData 
	   ){

	unsigned int i, j;

	double *buf = (double *) outputBuffer;
	double *lastValues = (double *) userData;
	
	if ( status )
		std::cout << "Stream underflow detected!" << std::endl;

	for ( i=0; i<nBufferFrames; i++ ) {

		*buf++ = lastValues[0];

		lastValues[0] += 0.005; 

		if ( lastValues[0] >= 1.0 ) lastValues[0] -= 2.0;
	}
	return 0;
}
