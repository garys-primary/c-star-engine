/*
*   Random sound synthesizer 
*
*		ref. https://gcc.gnu.org/onlinedocs/cpp
*		Author garys
*/

#define	F_CPU		16000000UL
#define BAUD		31250

#include <avr/io.h>
#include <util/delay.h>
#include <avr/interrupt.h>
#include <avr/pgmspace.h>
#include <math.h>
#include <util/setbaud.h>


//Function-like Macros
#define sbi(port, pin) (port |= (1<<pin))
#define cbi(port, pin) (port &= ~(1<<pin))
#define isHigh(reg, bit) (reg & (1<<bit))


//define bools
//TODO: optimization check
typedef struct { 
 uint8_t f0:1; 
 uint8_t f1:1; 
 uint8_t f2:1; 
 uint8_t f3:1; 
 uint8_t f4:1; 
 uint8_t f5:1; 
 uint8_t f6:1; 
 uint8_t f7:1; 
} Bits;

//bit usage example
#define enc1l ( (volatile Bits*)(&GPIOR0) )->f7

//wavetables
/*
uint8_t squareTable[2] = {0,255};
uint8_t sineTable[256] = {128,131,134,137,140,143,146,149,152,155,158,162,165,167,170,173,176,179,182,185,188,190,193,196,198,201,203,206,208,211,213,215,
218,220,222,224,226,228,230,232,234,235,237,238,240,241,243,244,245,246,248,249,250,250,251,252,253,253,254,254,254,255,255,255,
255,255,255,255,254,254,254,253,253,252,251,250,250,249,248,246,245,244,243,241,240,238,237,235,234,232,230,228,226,224,222,220,
218,215,213,211,208,206,203,201,198,196,193,190,188,185,182,179,176,173,170,167,165,162,158,155,152,149,146,143,140,137,134,131,
128,124,121,118,115,112,109,106,103,100,97,93,90,88,85,82,79,76,73,70,67,65,62,59,57,54,52,49,47,44,42,40,
37,35,33,31,29,27,25,23,21,20,18,17,15,14,12,11,10,9,7,6,5,5,4,3,2,2,1,1,1,0,0,0,
0,0,0,0,1,1,1,2,2,3,4,5,5,6,7,9,10,11,12,14,15,17,18,20,21,23,25,27,29,31,33,35,
37,40,42,44,47,49,52,54,57,59,62,65,67,70,73,76,79,82,85,88,90,93,97,100,103,106,109,112,115,118,121,124
};
*/

//256 bytes
const PROGMEM uint8_t sawTable[]={0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,
25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,
54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,
83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,
109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,
131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,
153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,
175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,
197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,
219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,
241,242,243,244,245,246,247,248,249,250,251,252,253,254,255};

//1024 bytes
const PROGMEM uint8_t sineTable[] = {128,128,129,130,131,131,132,133,134,135,135,136,137,138,138,139,140,141,142,142,143,144,145,145,146,147,148,149,149,150,151,152,152,153,154,155,155,156,157,158,158,159,160,161,162,162,163,164,165,165,166,167,167,168,169,170,170,171,172,173,173,174,175,176,176,177,178,178,179,180,181,181,182,183,183,184,185,186,186,187,188,188,189,190,190,191,192,192,193,194,194,195,196,196,197,198,198,199,200,200,201,202,202,203,203,204,205,205,206,207,207,208,208,209,210,210,211,211,212,213,213,214,214,215,215,216,217,217,
218,218,219,219,220,220,221,221,222,222,223,224,224,225,225,226,226,227,227,228,228,228,229,229,230,230,231,231,232,232,233,233,234,234,234,235,235,236,236,236,237,237,238,238,238,239,239,240,240,240,241,241,241,242,242,242,243,243,243,244,244,244,245,245,245,246,246,246,246,247,247,247,248,248,248,248,249,249,249,249,250,250,250,250,250,251,251,251,251,251,252,252,252,252,252,252,253,253,253,253,253,253,253,254,254,254,254,254,254,254,254,254,254,254,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,254,254,254,254,254,254,254,254,254,254,254,253,253,253,253,253,253,253,252,252,252,252,252,252,251,251,251,251,251,250,250,250,250,250,249,249,249,249,248,248,248,248,247,247,247,246,246,246,246,245,245,245,244,244,244,243,243,243,242,242,242,241,241,241,240,240,240,239,239,238,238,238,237,237,236,236,236,235,235,234,234,234,233,233,232,232,231,231,230,230,229,229,228,228,228,227,227,226,226,225,225,224,224,223,222,222,221,221,220,220,219,219,218,
218,217,217,216,215,215,214,214,213,213,212,211,211,210,210,209,208,208,207,207,206,205,205,204,203,203,202,202,201,200,200,199,198,198,197,196,196,195,194,194,193,192,192,191,190,190,189,188,188,187,186,186,185,184,183,183,182,181,181,180,179,178,178,177,176,176,175,174,173,173,172,171,170,170,169,168,167,167,166,165,165,164,163,162,162,161,160,159,158,158,157,156,155,155,154,153,152,152,151,150,149,149,148,147,146,145,145,144,143,142,142,141,140,139,138,138,137,136,135,135,134,133,132,131,131,130,129,128,
128,127,126,125,124,124,123,122,121,120,120,119,118,117,117,116,115,114,113,113,112,111,110,110,109,108,107,106,106,105,104,103,103,102,101,100,100,99,98,97,97,96,95,94,93,93,92,91,90,90,89,88,88,87,86,85,85,84,83,82,82,81,80,79,79,78,77,77,76,75,74,74,73,72,72,71,70,69,69,68,67,67,66,65,65,64,63,63,62,61,61,60,59,59,58,57,57,56,55,55,54,53,53,52,52,51,50,50,49,48,48,47,47,46,45,45,44,44,43,42,42,41,41,40,40,39,38,38,
37,37,36,36,35,35,34,34,33,33,32,31,31,30,30,29,29,28,28,27,27,27,26,26,25,25,24,24,23,23,22,22,21,21,21,20,20,19,19,19,18,18,17,17,17,16,16,15,15,15,14,14,14,13,13,13,12,12,12,11,11,11,10,10,10,9,9,9,9,8,8,8,7,7,7,7,6,6,6,6,5,5,5,5,5,4,4,4,4,4,3,3,3,3,3,3,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,3,3,3,3,3,3,4,4,4,4,4,5,5,5,5,5,6,6,6,6,7,7,7,7,8,8,8,9,9,9,9,10,10,10,11,11,11,12,12,12,13,13,13,14,14,14,15,15,15,16,16,17,17,17,18,18,19,19,19,20,20,21,21,21,22,22,23,23,24,24,25,25,26,26,27,27,27,28,28,29,29,30,30,31,31,32,33,33,34,34,35,35,36,36,37,
37,38,38,39,40,40,41,41,42,42,43,44,44,45,45,46,47,47,48,48,49,50,50,51,52,52,53,53,54,55,55,56,57,57,58,59,59,60,61,61,62,63,63,64,65,65,66,67,67,68,69,69,70,71,72,72,73,74,74,75,76,77,77,78,79,79,80,81,82,82,83,84,85,85,86,87,88,88,89,90,90,91,92,93,93,94,95,96,97,97,98,99,100,100,101,102,103,103,104,105,106,106,107,108,109,110,110,111,112,113,113,114,115,116,117,117,118,119,120,120,121,122,123,124,124,125,126,127
};

//1024 bytes
const PROGMEM uint8_t randomTable[] = {43,26,134,219,39,228,155,82,250,12,107,58,55,86,32,39,182,86,220,105,31,70,88,33,50,56,112,65,242,199,17,111,117,181,247,251,110,198,13,126,208,169,10,205,156,166,147,210,172,73,176,184,106,64,138,223,103,202,152,96,85,229,31,242,253,3,1,233,13,55,217,214,124,44,110,206,134,46,173,194,232,89,95,54,70,211,154,103,195,0,134,139,229,139,223,179,142,143,118,93,54,222,132,87,74,189,224,42,204,225,227,190,210,145,89,198,211,104,16,210,178,46,12,58,38,97,100,244,
48,177,170,89,239,110,90,26,9,15,16,19,112,140,66,62,219,177,191,132,226,108,28,45,133,220,190,19,229,97,21,237,54,34,200,1,44,143,17,27,175,49,201,235,36,164,96,194,129,252,133,7,67,124,254,24,83,116,129,248,75,106,200,208,253,193,254,120,78,145,204,55,228,188,241,59,189,221,161,235,242,145,36,11,128,30,39,9,188,245,217,197,187,241,159,44,186,183,32,83,148,45,20,71,173,147,197,239,130,250,209,5,221,220,89,246,56,129,89,56,31,211,116,206,160,243,0,69,
152,206,247,208,28,38,35,74,65,116,168,15,63,185,33,184,86,32,238,33,53,21,217,55,214,3,40,27,24,47,203,178,79,171,189,20,140,248,79,230,5,124,150,162,193,208,254,136,44,223,173,46,148,62,195,102,38,57,29,21,93,115,241,120,205,94,254,146,33,175,49,179,21,177,16,229,62,212,74,49,74,241,248,240,84,221,158,53,138,133,116,227,133,123,168,26,36,181,41,88,119,162,198,183,100,230,146,38,97,219,231,67,227,97,32,208,136,244,100,244,84,229,220,4,239,98,224,131,
9,69,248,254,170,108,202,144,84,57,136,254,67,115,188,189,167,249,204,148,176,14,96,12,96,232,106,182,192,191,215,246,225,13,96,197,20,89,230,152,171,192,249,121,202,249,155,206,189,50,233,105,73,90,116,184,72,161,137,198,114,163,123,223,47,26,66,90,25,69,120,243,18,162,187,170,131,157,89,1,191,139,32,167,145,181,249,36,105,111,177,4,158,248,165,236,79,9,60,27,48,66,50,188,91,43,137,65,47,245,45,218,194,126,145,5,74,17,106,106,71,54,129,175,232,221,119,42,
215,87,190,66,188,174,158,39,19,38,115,244,16,166,209,251,129,94,187,135,199,145,208,234,8,161,235,1,9,35,191,11,50,240,34,66,2,175,33,120,39,63,55,208,155,227,246,31,225,25,62,107,250,146,188,251,226,150,37,113,253,129,96,66,249,188,38,31,3,39,22,130,107,76,17,174,175,52,47,171,165,254,86,111,239,9,147,86,134,6,66,228,104,4,21,254,251,90,141,183,149,42,53,23,217,4,70,199,84,60,106,99,197,195,62,38,139,28,101,104,21,58,48,60,122,37,186,126,
35,65,152,135,108,76,151,215,19,198,143,253,217,182,161,130,209,170,42,29,47,20,55,200,37,111,55,243,106,238,86,172,107,128,115,240,32,164,56,232,120,92,240,28,195,1,242,62,149,101,176,28,53,6,39,228,240,251,54,91,79,116,160,116,173,34,249,73,187,76,207,171,206,92,85,238,198,137,205,177,43,145,74,121,119,70,26,22,145,191,53,196,91,47,243,120,75,237,122,179,176,149,73,217,85,21,164,18,71,50,145,116,31,229,139,194,115,195,68,187,226,185,198,182,62,76,234,244,
19,224,170,137,127,56,127,119,45,7,204,147,88,75,57,170,189,184,85,113,54,18,9,126,14,46,235,177,169,152,34,25,101,152,106,123,164,106,43,111,20,78,32,231,29,67,97,222,134,161,44,62,197,20,24,53,106,116,201,70,50,145,10,85,110,254,26,236,32,123,29,170,48,23,157,235,149,198,138,34,11,173,184,240,226,161,216,189,71,196,218,254,147,187,120,58,228,34,76,42,96,241,217,27,142,126,26,200,114,69,172,162,104,40,173,181,101,143,44,69,110,12,146,47,25,32,152,207,
170,133,59,107,18,56,52,214,68,37,35,82,181,82,22,133,102,213,57,24,182,26,61,13,32,107,149,175,136,17,238,230,171,213,149,68,136,116,147,215,168,149,63,190,207,175,89,94,87,63,190,177,58,119,49,176,129,20,1,68,148,243,255,62,160,58,57,18,144,244,192,240,43,230,231,227,66,111,167,186,49,202,162,161,107,89,86,203,11,168,125,147,144,8,184,21,146,238,114,38,141,99,29,15,162,154,251,4,63,33,25,228,113,154,162,187,251,25,2,189,13,89,54,205,230,247,240,24
};

//32 bytes
const PROGMEM uint8_t screwTable[] = {
128,202,250,255,210,190,82,32,12,4,0,1,3,8,22,58,
69,83,120,155,181,210,231,245,250,255,241,221,200,183,155,138
};

const PROGMEM uint8_t squareTable[] = {0,255};

volatile int intrCount = 0;
volatile int clock = 0;
volatile uint16_t frame = 0;

volatile int RV1 = 0;
volatile int RV2 = 0;
volatile int RV3 = 0;
volatile int RV4 = 0;
volatile int RV5 = 0;
volatile int RV6 = 0;

volatile float step = 0;
volatile float osc1Phase = 0;

//volatile uint8_t firSize = 10;
volatile uint16_t frameSum = 0;
volatile uint16_t frames[] = {0,0,0,0,0,0,0,0,0,0};


void outputToPins(int val);

void initIO(){
	//DDR  in=0 out=1
	//PORT in=1 out=0 - 1=pull-up 0=set pins low
	//reg. bit numbering: 76543210
	
	// o = audio out
	// m = midi IO
	// b = button in
	// c = adc ctrl in
	// x = doesn not exist on MCU
	
	// destin:oooooomm 
	DDRD  = 0b11111110;
	//PORTD = 0b11000000;
	
	// destin:xxbboooo
	DDRB	= 0b00001111;
	//PORTB = 0b00111100;
	
	// destin:xxcccccc
	DDRC	=	0b00000000;
	//PORTC	= 0b00011111;
}

/*void initTCNT(){
	//page 126
}*/

void initTimer(){	
	//create audio out frame @44100 Hz
  //init TCNT 1 (16 bit) into CTC mode (p. 87)
	OCR1A = 362; //value to reach
  TCCR1A = 0x00; //no setting in this register
	TCCR1B = (1 << CS10) | (1 << WGM12); //no prescale, internal clock, CTC mode w/ OCR1A as TOP value
	TIMSK = (1 << OCIE1A); //enable interrupts on compare p.100
}

volatile uint8_t i = 0;
volatile int pitch = 300;

ISR(TIMER1_COMPA_vect){
	outputToPins(frame);

	intrCount++;
	
	if(!(ADCSRA & (1<<ADSC))){
		switch(ADMUX){
			case 0b0000: //[ . ]  |
				RV1 = ADCW;
				ADMUX = 0b0001;
				break;
			case 0b0001: //[  .]  |
				RV2 = ADCW;
				ADMUX = 0b0010;
				break;
			case 0b0010: //[  ']  |
				RV3 = ADCW;
				ADMUX = 0b0011;
				break;
			case 0b0011: //[ ' ]  |
				RV4 = ADCW;
				ADMUX = 0b0100;
				break;
			case 0b0100: //['  ]
				RV5 = ADCW;
				ADMUX = 0b0101;
				break;
			case 0b0101: //[.  ]
				RV6 = ADCW;
				ADMUX = 0b0000;
				break;
			}
		ADCSRA |= (1<<ADSC);
	}
	
	//freq range: 10Hz .. 20000Hz
	//knob range: 0    .. 1023
	//step=20 fn= RV*20+10
	
	//generate square
	
	if(intrCount > pitch){
		frame = frame==0 ? RV4 : 0;
		intrCount = 0;
	}
	
	//RV1 = 500;
	
	//play from table
	step = RV1/1024.0*100.0;
	
	osc1Phase = osc1Phase+step>1023 ? 1023-osc1Phase+step : osc1Phase+step;
	//frame = pgm_read_byte_near(sineTable + (int)round(osc1Phase));
	//frame = pgm_read_byte_near(sawTable + (int)round(osc1Phase/4));
	
	
	//digital overdrive (needs work)
	//frame = (int)round(frame*(1024.0/(RV6+1)));
	
	
	//bit shift (???) - steppy amplitude but not noisy
	//frame = frame >> RV5/64;
	
	
	//Lowpass FIR
	/*frameSum = frame;
	for(i = 0; i < RV4/11; i++){
		frameSum += frames[i];
		frames[i+1]=frames[i];
	}
	frames[0] = frame;
	frame = (uint16_t)round(frameSum/(RV4/11));
	*/
	
	
}

void initADC(){
	ADCSRA  = (1<<ADEN) | (1<<ADPS2) | (1<<ADPS0); //last 2 is prescaler
}

ISR(USART_RXC_vect){
	pitch+=1;
}

void initUSART(){
//Interrupt vector p. 46
//v# 	addr. 	source				definition
//12	0x00B		USART, RXC		USART, Rx Complete

//vector name: USART_RXC, p.47

//allocate 10 bytes for buffer
// char* inMsg;
// inMsg = malloc(10);

	UBRRH = UBRRH_VALUE; //set baud rate
  UBRRL = UBRRL_VALUE;
	
  //MIDI format: start-bit + 8bit-data + stop-bit	
  UCSRB = (1<<RXEN) | (1<<RXCIE);   //Enable RX, enable interrupt on complete
	UCSRC = (1<<URSEL) | (1<<UCSZ1) | (1<<UCSZ0); 	//set 8 bit of data, start & 1 end bits are default
	

}



void outputToPins(int val){
	//LSB
	isHigh(val, 0) ? sbi(PORTD, PD2) : cbi(PORTD, PD2);
	isHigh(val, 1) ? sbi(PORTD, PD3) : cbi(PORTD, PD3);
	isHigh(val, 2) ? sbi(PORTD, PD4) : cbi(PORTD, PD4);
	isHigh(val, 3) ? sbi(PORTD, PD5) : cbi(PORTD, PD5);
	isHigh(val, 4) ? sbi(PORTD, PD6) : cbi(PORTD, PD6);
	isHigh(val, 5) ? sbi(PORTD, PD7) : cbi(PORTD, PD7);
	isHigh(val, 6) ? sbi(PORTB, PB0) : cbi(PORTB, PB0);
	isHigh(val, 7) ? sbi(PORTB, PB1) : cbi(PORTB, PB1);
	isHigh(val, 8) ? sbi(PORTB, PB2) : cbi(PORTB, PB2);
	isHigh(val, 9) ? sbi(PORTB, PB3) : cbi(PORTB, PB3);
	//MSB
}


uint8_t generate(int tabValue, int tonyNoisy, uint8_t shift){
	//uint8_t random = pgm_read_byte_near(randomTable + clock);
	//tonyNoisy+=(random/4);
	
	return pgm_read_byte_near(sineTable + tabValue + shift);
	
	/*if(tonyNoisy<128){
		return pgm_read_byte_near(sineTable + tabValue + shift);
	} else if (tonyNoisy<256) {
		return pgm_read_byte_near(squareTable + (tabValue + shift)/512);
	} else if (tonyNoisy<512) {
		return pgm_read_byte_near(screwTable + (tabValue + shift)/32);
	} else if (tonyNoisy<768) {
		return pgm_read_byte_near(randomTable + tabValue + shift);
	}	else {
		return pgm_read_byte_near(randomTable + clock);
	}	*/
}
		
int main(void){
	
	initIO();
	initUSART();
	initTimer();
	initADC();
	
	sei();
	
	ADMUX=0b0101;
	
	//uint16_t tabValue = 0;
	//uint16_t lfoStep = 0;
	//uint8_t random = 0;
	//uint8_t slowClock = 0;
	
	/*
	int outVal = 0;	
	int tabStep = 1;
	int decayStep = 0;
	int ampMod = 0;
	int randPitch = 0;
	int tonyNoisy = 0;
	int lfoSpeed = 0;
	*/
	//int ampProb = 0;
	//float subAttack = 0;
	//float amplitude = 0;
	//float subAmp = 0;
	
	
	while(1){	
		/*
		
		if(!(ADCSRA & (1<<ADSC))){
			switch(ADMUX){
				case 0b0000: //ADC5	RV6
					randPitch = ADCW;
					ADMUX = 0b0001;
					break;
				case 0b0001: //ADC4 RV5
					tabStep = ADCW;
					ADMUX = 0b0010;
					break;
				case 0b0010: //ADC3	RV4
					tonyNoisy = ADCW;
					ADMUX = 0b0011;
					break;
				case 0b0011: //ADC2	RV3
					lfoSpeed = ADCW;
					ADMUX = 0b0100;
					break;
				case 0b0100: //ADC1	RV2
					decayStep = ADCW;
					ADMUX = 0b0101;
					break;
				case 0b0101: //ADC0	RV1
					ampMod = ADCW;
					ADMUX = 0b0000;
					break;
				}
			ADCSRA |= (1<<ADSC);
		}
		*/
		
		
		/*
		if(tabValue + tabStep/128>=1024)
			tabValue += (float)(tabStep/128)-1024;
		else
			tabValue += tabStep/8;
		*/
		
		//tabValue += tabStep/8;
		
		/*
		if(isHigh(PINB, PB5))
			amplitude = 1;

				
		if(amplitude>0)
			amplitude-=(decayStep/(1024.0*200.0));
		else
			amplitude=0;
		*/
		
		/*
		if(isHigh(PINB, PB5))
			amplitude = 1023;
		*/
		
		/*outVal = (
			generate(tabValue, tonyNoisy, 0) 
			//+ generate(tabValue, tonyNoisy, 1) 
			//+ generate(tabValue, tonyNoisy, 5) 
			//+ generate(tabValue, tonyNoisy, 9) 
		) * amplitude;
		*/
		
		//outVal = pgm_read_byte_near(randomTable + tabValue) * amplitude;
		//outVal = genSine(tabValue) * amplitude;
		
		/*clock++;
		if(clock>tabStep){
			outVal = outVal==0 ? tonyNoisy : 0;
			clock=0;
		}
		
		
		outputToPins(outVal);	//outVal		
		*/
	}
	return 0;
}